#!/usr/bin/env python3
"""
Send .epub and .mobi books to Kindle
"""
import sys, subprocess, os.path, argparse

def known_extension(f):
    return f.endswith('.epub') or f.endswith('.mobi')

def check_type(filenames):
    unknown = [f for f in filenames if not known_extension(f)]
    if unknown:
        sys.stderr.write('Don\'t know how to process files: %s\n'
                         % ', '.join(unknown))
        sys.exit(1)

def convert_file(fnm):
    if fnm.endswith('.epub'):
        if subprocess.call(['kindlegen', fnm]) != 0:
            sys.stderr.write('Unable to convert %s to Mobi\n' % fnm)
            sys.exit(1)
        return fnm[:-4]+'.mobi'
    return fnm

def check_presence(filenames):
    missing = [f for f in filenames if not os.path.isfile(f)]
    if missing:
        sys.stderr.write('Cannot find files: %s\n' % ', '.join(missing))
        sys.exit(1)

def send(dest, filenames):
    email = dest+'@free.kindle.com'
    for fnm in filenames:
        args = ['emate', 'mailto', '-t', email, '--send-now', '-s', 'bokz', fnm]
        if subprocess.call(args) != 0:
            sys.stderr.write('Unable to send e-mail with %s to Kindle\n' % fnm)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('books', metavar='BOOK', nargs='+',
                        help='Books to send')
    parser.add_argument('-t', '--to', help='Kindle address to send books to')
    args = parser.parse_args()
    if not args.to:
        args.to = 'dottedmag'
    check_type(args.books)
    filenames = [convert_file(f) for f in args.books]
    check_presence(args.books)
    send(args.to, args.books)

if __name__ == '__main__':
    main()
